<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Awesome Library</title>
</head>
<style>
.hidden { visibility: hidden; }
#error-notification {
    background-color: mistyrose;
    border: red solid;
    border-radius: 0.5em;
    padding: 0.3em;
    margin-bottom: 1rem;
}
ul {
    list-style: none;
    padding-inline-start: 0;
}
li:nth-child(odd) {
    background-color: aliceblue;
}

</style>
<script>

function displayError(message, serverErrorText) {
    if( serverErrorText && serverErrorText.length < 60 ) {
        message = `${message}, Reason: ${serverErrorText}`;
    }
    const html = `<span><strong>Error:</strong> ${message}.</span>`;
    const errorBox = document.getElementById('error-notification');
    errorBox.classList.remove('hidden');
    errorBox.innerHTML = html;
}

function clearError() {
    const errorBox = document.getElementById('error-notification');
    errorBox.innerHTML = '';
    errorBox.classList = ['hidden'];
}

async function safeFetch(...args) {
    clearError();
    const response = await fetch(...args);
    if( response.ok ) {
        return response.json();
    }
    throw new Error(await response.text());
}

function updateList(books) {
    const listDomString = books.map( book => {
        let content = book.title;
        if(book.author) {
            const authorName = typeof(book.author) === 'string' ? book.author : book.author.name;
            content = content.concat(` - ${authorName}`);
        }
        return `<li>${content}</li>`;
    }).reduce((acc, val) => acc + val, '');
    document.getElementById('book-list').innerHTML = listDomString;
}

async function refreshList() {
    try {
        const books = await safeFetch(`${window.origin}/books`);
        updateList( books );
    } catch (e) {
        displayError('Could not retrieve books', e.message);
    }
}

function getInputValueAndClear(id) {
    const element = document.getElementById(id);
    const value = element.value;
    element.value = '';
    return value;
}

async function postBook() {
    const title = getInputValueAndClear('title-input');
    const author = getInputValueAndClear('author-input');
    const book = { title, author };
    try {
        await safeFetch(`${window.origin}/books`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(book)
        });
        refreshList();
    } catch (e) {
        displayError('Could not create book', e.message);
    }
}

async function searchTitle() {
    const title = document.getElementById('title-search-input').value;
    try {
        let json = await safeFetch(`${window.origin}/books/${title}`);
        if( !(json instanceof Array)) {
            json = [ json ];
        }
        updateList( json );
    } catch(e) {
        displayError(`Could not find book with title '${title}'`, e.message);
    }
}

if( document.readyState !== 'loading' ) {
    refreshList();
} else {
    document.addEventListener('DOMContentLoaded', refreshList);
}

</script>
<body>
<h1>Awesome Library</h1>
<div id="error-notification" class="hidden"></div>
<div>
    <label>Title:</label>
    <input id="title-search-input" type="text">
    <button onclick="searchTitle()">ðŸ”Ž Search</button>
</div>
<button onclick="refreshList()">ðŸ”„ List all books</button>
<ul id="book-list"></ul>
<div>
    <label>Title:</label>
    <input id="title-input" type="text"/>
    <label>Author:</label>
    <input id="author-input" type="text"/>
    <button onclick="postBook()">âž• Add</button>
</div>
</body>
</html>